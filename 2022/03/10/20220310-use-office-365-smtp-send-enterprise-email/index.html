<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>使用 office 365 SMTP 发送企业邮件 | 曹立禄的网络日志</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">使用 office 365 SMTP 发送企业邮件</h1><a id="logo" href="/.">曹立禄的网络日志</a><p class="description">I am penny-pincher/tightwad/cheapskate javascript Vulgar man!</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/categories/Coding/"><i class="fa fa-bug"> 码农笔记</i></a><a href="/categories/Tittle-tattle/"><i class="fa fa-beer"> 杂谈</i></a><a href="/categories/Photography/"><i class="fa fa-camera"> 摄影说</i></a><a href="/tags/"><i class="fa fa-bookmark"> 标签</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">使用 office 365 SMTP 发送企业邮件</h1><div class="post-meta">2022-03-10<span> | </span><span class="category"><a href="/categories/Coding/">Coding</a></span></div><div class="post-content"><p><img src="https://img-blog.csdnimg.cn/img_convert/2dc0a300e43a44c132b326ffeed4b11d.png"></p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>最近公司的企业邮箱从 gmail 迁移到了 office 365。不得不说，微软 office 套件的功能在市场上还是无人可以取代的。公司自然需要用 office 365 向客户发送邮件，因此需要重新配置项目的 SMTP 服务器。</p>
<p>一开始直接将 gamil 的 SMTP 服务器地址换成 office 365 的地址即“smtp.office365.com”，但是一直收到下面的错误提示，很容易想到是用户名和密码错误，在确认用户名和密码没有问题之后错误仍然一直存在，在查阅资料（baidu，google，bing）之后，也一直没找到合适的解决方案（基本都是在贴各种常规代码），最终在和客服进行几次交流之后找到了问题的所在。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">	File &quot;&#x2F;Users&#x2F;crown&#x2F;Projects&#x2F;hub&#x2F;docs&#x2F;email-try.py&quot;, line 49, in send</span><br><span class="line">		smtp_obj.login(&#39;lilu.cao@orbitfin.ai&#39;,&quot;xxx&quot;)</span><br><span class="line">	File &quot;&#x2F;opt&#x2F;miniconda3&#x2F;envs&#x2F;webtest&#x2F;Lib&#x2F;python3.7&#x2F;smtplib.py&quot;, line 730, in Login</span><br><span class="line">		raise last_exception</span><br><span class="line">	File &quot;&#x2F;opt&#x2F;miniconda3&#x2F;envs&#x2F;webtest&#x2F;lib&#x2F;python3.7&#x2F;smtplib.py&quot;, line 721, in login</span><br><span class="line">		initial_response_ok&#x3D;initial_response_ok)</span><br><span class="line">	File &quot;&#x2F;opt&#x2F;miniconda3&#x2F;envs&#x2F;webtest&#x2F;lib&#x2F;python3.7&#x2F;smtplib.py&quot;, line 642, in auth</span><br><span class="line">		raise SMTPAuthenticationError(code, resp)</span><br><span class="line">smtplib.SMTPAuthenticationError: (535, b&#39;5.7.139 Authentication unsuccessful, the request did not meet the criteria to be authenticated successfully.</span><br></pre></td></tr></table></figure>

<p>接下来通过配置下面三个步骤完成邮箱的 SMTP 邮件发送。</p>
<h2 id="三步配置"><a href="#三步配置" class="headerlink" title="三步配置"></a>三步配置</h2><h4 id="正确的发送代码（python）"><a href="#正确的发送代码（python）" class="headerlink" title="正确的发送代码（python）"></a>正确的发送代码（python）</h4><p>这一步是最简单的，网上有很多优秀的封装的 email 发送类，我这里贴出一个之前用过的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> emails</span><br><span class="line"><span class="keyword">from</span> emails.template <span class="keyword">import</span> JinjaTemplate <span class="keyword">as</span> T</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">USERNAME = <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">PASSWORD = <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">smtp_conf = &#123;<span class="string">&#x27;host&#x27;</span>: <span class="string">&#x27;smtp.office365.com&#x27;</span>,</span><br><span class="line">             <span class="string">&#x27;user&#x27;</span>: USERNAME,</span><br><span class="line">             <span class="string">&#x27;password&#x27;</span>: PASSWORD,</span><br><span class="line">             <span class="string">&#x27;port&#x27;</span>: <span class="number">587</span>,</span><br><span class="line">             <span class="string">&#x27;tls&#x27;</span>: <span class="literal">True</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_email</span>():</span></span><br><span class="line">    message = emails.html(subject=T(<span class="string">&#x27;测试邮件&#x27;</span>),</span><br><span class="line">                          html=T(<span class="string">&#x27;&lt;p&gt;详情见附件&lt;br&gt;&lt;br&gt;&#x27;</span>),</span><br><span class="line">                          mail_from=(<span class="string">&#x27;auto-reporter&#x27;</span>, USERNAME))</span><br><span class="line">    message.attach(data=open(<span class="string">&#x27;readme.md&#x27;</span>, <span class="string">&#x27;r&#x27;</span>), filename=<span class="string">&quot;readme.txt&quot;</span>)</span><br><span class="line">    r = message.send(to=(<span class="string">&#x27;Orangleliu&#x27;</span>, USERNAME), smtp=smtp_conf)</span><br><span class="line">    print(r)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">office365</span>():</span></span><br><span class="line">    <span class="keyword">import</span> smtplib</span><br><span class="line">    mailserver = smtplib.SMTP(<span class="string">&#x27;smtp.office365.com&#x27;</span>, <span class="number">587</span>)</span><br><span class="line">    mailserver.ehlo()</span><br><span class="line">    mailserver.starttls()</span><br><span class="line">    mailserver.login(USERNAME, PASSWORD)</span><br><span class="line">    mailserver.sendmail(USERNAME, USERNAME, <span class="string">&#x27;python email&#x27;</span>)</span><br><span class="line">    mailserver.quit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    send_email()</span><br><span class="line"></span><br><span class="line">————————————————</span><br><span class="line">版权声明：本文为CSDN博主「orangleliu」的原创文章，遵循CC <span class="number">4.0</span> BY-SA版权协议，转载请附上原文出处链接及本声明。</span><br><span class="line">原文链接：https://blog.csdn.net/orangleliu/article/details/<span class="number">84065548</span></span><br></pre></td></tr></table></figure>

<p>需要注意的是，在使用 office 365 的 smtp 服务的时候，加密要用 tls 而不是 ssl，也就是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mailserver.starttls()</span><br></pre></td></tr></table></figure>

<h4 id="在组织中启用-SMTP-AUTH"><a href="#在组织中启用-SMTP-AUTH" class="headerlink" title="在组织中启用 SMTP AUTH"></a>在组织中启用 SMTP AUTH</h4><p>office 365 默认是对每一个用户都不启用 SMTP AUTH 的，因此我们需要对要使用 SMTP 进行发送邮件的用户开启 SMTP AUTH。一共有两种开启方式，一种是管理员登录 admin 控制中心（<a target="_blank" rel="noopener" href="https://admin.microsoft.com/%EF%BC%89%E9%92%88%E5%AF%B9%E7%9B%B8%E5%BA%94%E7%9A%84%E7%94%A8%E6%88%B7%E8%BF%9B%E8%A1%8C%E5%BC%80%E5%90%AF%E3%80%82%E5%85%B7%E4%BD%93%E6%AD%A5%E9%AA%A4%E5%A6%82%E4%B8%8B%EF%BC%9A">https://admin.microsoft.com/）针对相应的用户进行开启。具体步骤如下：</a></p>
<p><strong>1）登入 office 365 管理中心</strong></p>
<p>通过 <a target="_blank" rel="noopener" href="https://admin.microsoft.com/">https://admin.microsoft.com/</a> 登入管理中心，然后根据下图依次点击找到对应用户的 “Manage email apps”。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/141486056420e3399262fdaa248baca0.png"></p>
<p><strong>2）勾选 Authenticated SMTP</strong></p>
<p>然后点击 Manage email apps，在打开的侧边栏中将最后一项 “Authenticated SMTP” 勾选上。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/9469c31490c448a59fbe12407905e62e.png"></p>
<p>第二种方式是通过 powershell 进行操作，这种方式在这里不做具体阐述，具体可以参考下面的官网链接。</p>
<p>[中文版本] <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/exchange/clients-and-mobile-in-exchange-online/authenticated-client-smtp-submission">https://docs.microsoft.com/zh-cn/exchange/clients-and-mobile-in-exchange-online/authenticated-client-smtp-submission</a></p>
<p>[英文版本] <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/exchange/clients-and-mobile-in-exchange-online/authenticated-client-smtp-submission">https://docs.microsoft.com/en-us/exchange/clients-and-mobile-in-exchange-online/authenticated-client-smtp-submission</a> </p>
<h4 id="关闭安全性默认值"><a href="#关闭安全性默认值" class="headerlink" title="关闭安全性默认值"></a>关闭安全性默认值</h4><p>这一步至关重要，即便是我们开启了 SMTP AUTH，如果没有关闭安全默认值，那么邮件也无法使用。这一点其实已经在上面的“启用或禁用通过身份验证的客户端 SMTP (SMTP AUTH) Exchange Online”文章中指出，只是我们很难注意到这个点。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/789dc515dd22203b83e8ed176d933abb.png"></p>
<p>关于什么是“安全默认值”，可以参考下面点文章。</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/concept-fundamentals-security-defaults">https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/concept-fundamentals-security-defaults</a></p>
<p>下面是关闭“安全默认值”的步骤</p>
<p><strong>1) 进入 Azure active directory</strong></p>
<p>我们进入 admin 管理中心后，根据下图，进入 Azure active directory。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/e383a4e6d3e5563fb3654885cbed24a1.png"></p>
<p><strong>2) 关闭安全默认值</strong></p>
<p>在 Azure active directory 界面，通过下图的指示，关闭安全默认值。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/fbb28c52fed57a8f68566e8a310e1189.png"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>完成上述三个步骤，我们就可以成功的通过 python 使用 office 365 的 SMTP 进行邮件发送。尤其是最有一步，对于默认安全值的问题，如果没有咨询微软的客服，很难排查出发送失败的原因。</p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p>[1] Python 使用office365邮箱自动发送邮件 <a target="_blank" rel="noopener" href="https://blog.csdn.net/orangleliu/article/details/84065548?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_ecpm_v1~rank_v31_ecpm-1-84065548.pc_agg_new_rank&amp;utm_term=Python+%E4%BD%BF%E7%94%A8office365%E9%82%AE%E7%AE%B1%E8%87%AA%E5%8A%A8%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6&amp;spm=1000.2123.3001.4430">https://blog.csdn.net/orangleliu/article/details/84065548?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_ecpm_v1~rank_v31_ecpm-1-84065548.pc_agg_new_rank&amp;utm_term=Python+%E4%BD%BF%E7%94%A8office365%E9%82%AE%E7%AE%B1%E8%87%AA%E5%8A%A8%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6&amp;spm=1000.2123.3001.4430</a><br>[2] python3使用smtplib发送邮件，带xlsx附件 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiao987334176/p/11975248.html">https://www.cnblogs.com/xiao987334176/p/11975248.html</a><br>[3] 启用或禁用通过身份验证的客户端 SMTP (SMTP AUTH) Exchange Online <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/exchange/clients-and-mobile-in-exchange-online/authenticated-client-smtp-submission">https://docs.microsoft.com/zh-cn/exchange/clients-and-mobile-in-exchange-online/authenticated-client-smtp-submission</a><br>[4] Enable or disable authenticated client SMTP submission (SMTP AUTH) in Exchange Online <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/exchange/clients-and-mobile-in-exchange-online/authenticated-client-smtp-submission">https://docs.microsoft.com/en-us/exchange/clients-and-mobile-in-exchange-online/authenticated-client-smtp-submission</a><br>[5] Security defaults in Azure AD <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/concept-fundamentals-security-defaults">https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/concept-fundamentals-security-defaults</a></p>
</div><div class="tags"><a href="/tags/%E9%9A%8F%E7%AC%94/"><i class="fa fa-tag"></i>随笔</a></div><div class="post-nav"><a class="pre" href="/2022/03/27/20220327-esLint-with-prettier-standardize-frontend-code/">ESLint 和 Prettier 工程化前端代码</a><a class="next" href="/2022/02/01/20220201-django-drf-global_exception-handle-2/">Django 与 DRF 结合的全局异常处理方案</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://example.com"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Coding/">Coding</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Reading/">Reading</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tittle-tattle/">Tittle-tattle</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/WEB/" style="font-size: 15px;">WEB</a> <a href="/tags/Javascript/" style="font-size: 15px;">Javascript</a> <a href="/tags/%E5%A5%BD%E6%96%87/" style="font-size: 15px;">好文</a> <a href="/tags/DB/" style="font-size: 15px;">DB</a> <a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 15px;">后端</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 15px;">随笔</a> <a href="/tags/%E8%AF%BB%E4%B9%A6/" style="font-size: 15px;">读书</a> <a href="/tags/%E6%9D%82%E8%B0%88/" style="font-size: 15px;">杂谈</a> <a href="/tags/AWS/" style="font-size: 15px;">AWS</a> <a href="/tags/python/" style="font-size: 15px;">python</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2022/10/19/20221019-aws-sqs-boto3-python/">AWS SQS, Boto3 and Python：带示例的完整指南</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/09/29/20220929-principle-of-jwt-token/">JWT(Json Web Token) 的原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/07/10/20220710-deploy-aws-lambda-with-docker/">在 AWS lambda 上部署 docker 应用</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/07/05/20220705-shui-hu-de-shui-you-duo-shen/">读后：水浒的水有多深</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/07/03/20220703-profile-and-bashrc/">profile 和 bashrc 的区别</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/05/10/20220510-how-https-protect-data-transfer/">https 是如何保护数据传输的</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/04/08/20220408-resolve-es-fvh-not-highlight-data-type/">解决 Elastic Search 的 Fast Vector Highlighting (FVH) 策略无法高亮 nested 数据类型</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/03/27/20220327-esLint-with-prettier-standardize-frontend-code/">ESLint 和 Prettier 工程化前端代码</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/03/10/20220310-use-office-365-smtp-send-enterprise-email/">使用 office 365 SMTP 发送企业邮件</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/02/01/20220201-django-drf-global_exception-handle-2/">Django 与 DRF 结合的全局异常处理方案</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="/archives/" title="文章归档" target="_blank">文章归档</a><ul></ul><a href="https://github.com/clown-0726?tab=repositories" title="GITHUB" target="_blank">GITHUB</a><ul></ul><a href="https://www.orbitfin.ai/" title="Orbit Financial Technology" target="_blank">Orbit Financial Technology</a><ul></ul><a href="http://www.ruanyifeng.com/home.html" title="阮一峰" target="_blank">阮一峰</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/." rel="nofollow">曹立禄的网络日志.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="http://beian.miit.gov.cn/"> 辽ICP备2020013446号</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>